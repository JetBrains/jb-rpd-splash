<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />

        <!-- RPD: css -->
        <link rel="stylesheet" href="./rpd.css"></link>
        <!-- Toolkit: jb (svg) -->
        <link rel="stylesheet" href="./toolkit/jb/svg.css"></link>

        <!-- Kefir.js library -->
        <script src="./kefir.min.js"></script>

        <!-- RPD Library (http://shamansir.github.io/rpd) -->
        <script src="./rpd.min.js"></script>

        <!-- Toolkit: jb, utils -->
        <script src="./toolkit/jb/shared.js"></script>
        <!-- Toolkit: jb -->
        <script src="./toolkit/jb/toolkit.js"></script>
        <!-- Toolkit: jb (svg) -->
        <script src="./toolkit/jb/svg.js"></script>

        <!-- p5.js -->
        <script src="./p5.min.js"></script>
        <script src="./p5.dom.js"></script>

        <!-- d3.voronoi.js -->
        <script src="./d3-voronoi.v1.min.js"></script>

        <style>
            body {
                margin: 0;
                padding: 0;
            }

            #overlay {
                background-color: rgba(0,0,0,0.5);
                opacity: 1;
                transition: opacity 500ms ease-in;
            }

            #overlay.hidden {
                opacity: 0;
            }

            #patch-target {
                opacity: 1;
                transition: opacity 500ms ease-in;
            }

            #patch-target.hidden {
                opacity: 0;
            }

            #patch-target .rpd-background {
                /* fill: transparent; */
                opacity: 0.3;
            }

            #rpd-jb-preview-target {
                position: fixed;
            }

            #rpd-jb-preview-target,
            #rpd-jb-preview-target canvas {
                background: #12181C;
            }

            #front-layer {
                position: relative;
            }
        </style>

    </head>
    <body>

        <div id="rpd-jb-preview-target"></div>
        <div id="front-layer">
            <div id="overlay"></div>
            <div id="patch-target"></div>
        </div>

        <script>
            // Build and render patch

            var patch = Rpd.addPatch('jb-sketch');

            patch.render('svg', document.getElementById('patch-target'),
                         { style: 'ableton-out',
                           fullPage: true,
                           linkForm: 'curve' });
            var render1 = patch.addNode('jb/render').move(220, 310);
            var render2 = patch.addNode('jb/render').move(620, 280);

            var layers = patch.addNode('jb/layers').move(475, 290);

            var ellipse = patch.addNode('jb/ellipse').move(60, 130);
            ellipse.outlets['forms'].connect(render1.inlets['forms']);

            var knob1 = patch.addNode('util/knob').move(170, 40);
            var knob2 = patch.addNode('util/knob').move(250, 40);

            var transform = patch.addNode('jb/transform').move(380, 90);
            knob1.outlets['number'].connect(transform.inlets['x']);
            knob2.outlets['number'].connect(transform.inlets['y']);
            knob1.inlets['submit'].receive(0.2);

            ellipse.outlets['forms'].connect(transform.inlets['forms']);
            ellipse.outlets['forms'].connect(layers.inlets['L0']);
            transform.outlets['forms'].connect(layers.inlets['L1']);
            layers.outlets['forms'].connect(render2.inlets['forms']);

            var bang = patch.addNode('util/bang').move(10,10);
            bang.outlets['bang'].connect(ellipse.inlets['bang']);
            setTimeout(function() {
                bang.inlets['trigger'].receive({})
            }, 100);

            patch.addNode('util/nodelist').move(800, 50);

            var previewTarget = document.getElementById('rpd-jb-preview-target');
            previewTarget.style.width = window.innerWidth + 'px';
            previewTarget.style.height = window.innerHeight + 'px';

            var overlayElm = document.getElementById('overlay');
            var patchElm = document.getElementById('patch-target');
            Kefir.fromEvents(document.body, 'keydown').filter(function(evt) {
                return evt.keyCode === 32;
            }).scan(function(prev, next) {
                return !prev;
            }, true).onValue(function(value) {
                overlayElm.className = value ? 'visible' : 'hidden';
                patchElm.className = value ? 'visible' : 'hidden';
            });

        </script>

    </body>
</html>
